### [如何实现 MySQL 的读写分离？如何解决 MySQL 主从同步的延时问题？](https://zhuanlan.zhihu.com/p/60455737)

## **`如何实现MySQL读写分离`**
### 读写分离使用场景
* 实际上大部分互联网产品, 如网站或App, 其实都是读多写少. 为了缓解读数据的负载, 就采用写数据用一个主库
* 然后在主库上挂多个从库, 从库针对读服务. 主库会自动把数据给同步到从库上去, 这就可以支撑更高的并发


## **`MySQL主从复制原理`**
### 主从复制步骤
1. 主库将数据变更写入binlog日志, 从库连接到主库后, 从库有一个IO线程, 将主库的binlog日志复制到自己本地, 写入一个relay中继日志中
2. 从库中有一个SQL线程会从中继日志读取binlog, 然后执行binlog日志的内容, 也就是SQL语句. 这样就可以保证主从数据一致

### 主从复制重点
* 从库同步主库数据的过程是串行化的, 也就是说主库上并行的操作在从库上会串行执行
* 所以从库从主库复制日志(IO时间)以及串行执行SQL(非并发执行)的特点, 导致在高并发场景下, 从库的数据更新会比主库慢, 即有延迟
* 所以在一些场景中经常出现, 刚写入主库的内容读取的时候没有及时更新, 需要等待几十毫秒甚至几百毫秒才能读取
* 还有一种情况, 如果主库突然宕机, 这时候数据还没同步到从库, 则会导致数据丢失


## **`如何解决MySQL主从同步问题`**
1. 解决主库宕机, 从库数据丢失问题 -- 半同步复制
2. 解决主从同步延时问题 -- 并行复制

### 半同步复制
* 半同步复制(semi-sync复制), 是指当主库写入binlog日志后， 强制命令从库同步binlog. 
* 从库将binlog写入本地relay log之后, 返回ack给主库, 主库至少接收到一个从库的ack之后才认为完成写操作

### 并行复制
* 并行复制是指从库开启多个线程, 并行读取relay log中不同表的日志, 然后并行执行这些日志, 降低延迟

### 查看延时时间
在`show status`中查看`Seconds_Behind_Master`, 可以看到从库复制主库的数据落后了多少ms

### 主从延迟较为严重时的解决方案
1. 分库, 将一个主库拆分成多个主库, 缓解主库的并发写压力, 此时主从延迟可以忽略不计
2. 并行复制, 如果某个库写入并发特别高的话, 效果不理想
3. 如果某些数据特别重要, 需要更新及时. 可以将这个查询设置直连主库. 但是这么做的话读写分离, 主从复制就没有意义